# PromptCard 説明

PromptCard は「生成指示 (Prompt)」と「評価基準 (Rubric)」を 1 つの仕様書にまとめ、生成・評価・改善の各フェーズを同一ドキュメントで制御するための枠組みです。従来のプロンプトに不足していた「検証可能性」「資産性」「変更履歴」をカバーし、ソフトウェア開発でいう仕様書・テストコード・リファクタリング指針を一体化します。

## 導入目的
- プロンプト品質を可視化して改善ループを作る  
- AI エージェントが安定した出力を返すための評価基準を共有する  
- プロンプトの意図や背景を新規開発者や他ツールにも正確に伝える  
- Rubric を使った自動検証 (delta verify など) を可能にする  
- プロンプトをリポジトリ管理し、属人性の高い資産からソフトウェア資産へ格上げする  

## カスタマイズ

`context-delta/promptcards/` には PRD/SRS/Behavior/Model/API/Data/Architecture/Delivery/Module など主要な PromptCard がプリインストールされていますが、各カードはプロジェクトに合わせて編集できます。Rubric やサンプル、Regression Set を更新したり、新しい PromptCard (`pc.*`) を追加したら `delta card sync` を実行して `docs/promptcards/registry.(md|json)` を再生成してください。これにより delta propose/apply/archive/verify が最新のカードを参照し、カスタム基準に沿った生成・検証が可能になります。

## Markdown 構成
PromptCard は YAML Front Matter と複数の Markdown セクションで管理します。下記は USDM 準拠 SRS 生成向け PromptCard のサンプル (version 情報付き) です。

```markdown
---
id: pc.srs.usdm
title: USDM準拠・要求仕様書ジェネレーター
version: 1.0.0
status: stable
targets:
  - docs/specs/usdm-srs.md
purpose: USDM形式（要求/理由/説明/仕様）に準拠した要求仕様書を再現性高く生成する
---

🪶 PromptCard: USDM準拠・要求仕様書（SRS）ジェネレーター

🎯 Intent（目的）

目的: ユーザーが提供するビジネス目標・制約・例示から、USDM形式（要求/理由/説明/仕様）に準拠した要求仕様書（SRS）を再現性高く生成する。  
成果: 要求⇄仕様が階層とIDで明確につながり、受入基準/テスト観点までトレース可能なドキュメントを得る。  
参考: USDMは「要求を目的語＋動詞で記述し、そこから仕様を導出」「要求/仕様の階層化とID管理」「Excel等での管理」を重視。 (Qiita +1)

👥 Audience（対象）

ペルソナ: プロダクトマネージャ、要件定義担当、システムエンジニア、QA/テストリーダー、発注側PMO。  
熟練度: 初級〜上級（USDM未経験でも運用可）。  
前提知識: 基本的なシステム開発用語。  
避ける専門用語: 内部設計用語（内部API名、内部クラス名等）を仕様レベルに持ち込みすぎない。

🧷 Controls（制御パラメータ）

文体/トーン: 実務的・丁寧（敬体）。  
詳細度: High（表・箇条書き中心／例示あり）。  
分量: 5,000–12,000字相当（A4換算 8–20p）※プロジェクト規模で自動伸縮。  
用語表: あり（表記統一例：「ログイン/サインイン」を「ログイン」に統一）。  
引用/出典形式: 末尾参考（必要に応じて脚注併用）。  
図表/コードブロック: 必須（USDM表、階層図例、CSV/YAMLエクスポート）。  
ローカライズ: 日付=ISO8601（YYYY-MM-DD）、数値=SI単位、通貨=JPY（¥）。  
禁止事項: 誇大・断定、暗黙の設計（設計の持ち込み）、根拠のない非機能値、機密情報の露出、生成ポリシー違反。  
USDM準拠の要点:

- 要求は目的語＋動詞で１文単位。  
- 要求→仕様の導出根拠を明示（仕様は必ずどこかの要求に紐付く）。  
- 階層化/ID付与とトレーサビリティ（受入基準・テスト観点・他成果物）を維持。 (Qiita +2 / Sky Group +2)

🧩 Document Outline（章立て案）

- 第1章: 序文／目的・範囲 — ドキュメントの目的、対象読者、対象システム、非対象（[CRITICAL]）背景・上位目標、用語定義、想定環境、前提・制約
- 第2章: ステークホルダとゴール — 主要ステークホルダ、業務/ユーザーゴール（[CRITICAL]）
- 第3章: USDM要求仕様（全体構造） — 要求/理由/説明/仕様テーブル＋階層図（[CRITICAL]）IDポリシー、命名規則（例：R-001, R-001.1 / S-001, S-001.1 など）
- 第4章: 非機能要求（USDMでの表現） — 性能・可用性・セキュリティ等をUSDM表で管理（[CRITICAL]）
- 第5章: 受入基準とテスト観点の紐づけ — 仕様ごとの検証方法・出口条件（[CRITICAL]）
- 第6章: トレーサビリティ — 仕様⇄要求⇄テスト⇄設計/チケット/変更履歴（[CRITICAL]）
- 第7章: リスク・課題・決定事項（ADR要約）（[CRITICAL]）
- 第8章: 変更管理・バージョニング — ID固定・差分運用方針（[TRIVIAL]）
- 付録: 用語集、参照資料、テンプレ（Markdown/CSV/YAML）

🧭 Rubric（評価基準・重み・重要度）

合計100%。各観点に Weight(%) と [CRITICAL]/[TRIVIAL] を付与。0–4の記述子で採点。

| 観点 | Weight | Importance | 4 | 3 | 2 | 1 | 0 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 目的整合性（Intent Fit） | 15 | [CRITICAL] | 章立て・内容が目的/範囲と完全整合 | 概ね整合 | 一部弱い | 目的から逸脱 | 不一致 |
| USDM準拠度（要素・導出・階層） | 20 | [CRITICAL] | 要求/理由/説明/仕様・階層・導出根拠が完璧 | 小さな欠落 | 形式不足 | 形式崩れ | 非準拠 |
| 網羅性/具体性 | 20 | [CRITICAL] | 必須論点＋具体例・数値あり | 概ね網羅 | 抽象混在 | 抜け多い | 重大欠落 |
| 論理構造/一貫性 | 10 | [CRITICAL] | 上下位・横断関係が明確 | 軽微な飛躍 | 冗長/重複 | 矛盾散在 | 破綻 |
| トレーサビリティ/検証可能性 | 15 | [CRITICAL] | 仕様⇄要求⇄受入/テストが往復可 | ほぼ可 | 一部曖昧 | 根拠弱い | 不可 |
| 読者適合（トーン/可読性） | 5 | [TRIVIAL] | 読者に最適・表記統一 | 概ね適合 | 語調揺れ | 違和感 | 不適切 |
| 形式遵守（本カードの指示） | 5 | [TRIVIAL] | 完全準拠 | 軽微逸脱 | 逸脱複数 | 頻繁な逸脱 | 無視 |
| リスク/制約の明示 | 10 | [CRITICAL] | 主要リスクと緩和策が具体 | 大枠あり | 抽象的 | ほぼ無 | 無 |

合否判定: Pass = 合計 ≥ 75 かつ [CRITICAL] 全て ≥ 2 ／ Borderline = 65–74 または [CRITICAL] に 1 を含む ／ Fail = < 65 または [CRITICAL] に 0 を含む

🚫 Non-Goals / Anti-Patterns

- 実装詳細（内部構造・クラス設計）への踏み込み  
- 出典や前提のない性能値・SLA  
- USDM項目の混同（要求に仕様を書く／仕様に意図を書く）  
- IDの可変化（版が変わってもIDは原則不変）  

🔒 Compliance / Privacy

- 個人情報・秘匿情報は削除/仮名化。外部公開版では数値の丸め/伏字化。  
- 引用は短文引用に留め、出典を明示。  
- セキュリティ要件は脅威の具体化を避け、受入基準で十分性を担保。  

📌 Assumptions / Constraints

- USDMは要求→仕様の導出と階層管理/ID付与を基本とする。 (Qiita +1)  
- 実務ではExcel等を用い、右側列で他成果物と連携する運用が一般的。 (Eureka Box)  
- 「範囲」「階層化」を重視し、目的語＋動詞で記述する。 (Sky Group)  

❓ Questions for User（不明点の確認）

- 対象システムの名称/目的/主要ユーザーは？  
- 上位ビジネスゴールと非対象範囲は？  
- 最重要の上位要求（3〜7件）と、その理由は？  
- 非機能の優先トップ3（例：性能/可用性/セキュリティ）と目標値は？  
- 想定する受入基準（ユーザー/運用/法規）は？  
- 参照すべき既存成果物（課題チケット、既存仕様、規格）は？  
- 出力形式の希望（Markdown/CSV/Excel変換前提）と版管理方針は？  

※本カードは質問を行いつつ、入力が不完全でもドラフトを同時提示する運用を想定。

🧠 Notes（判断理由・設計意図）

- USDMの実務では表（要求/理由/説明/仕様）と階層IDが核。テーブル主導で品質評価（Rubric）を回せるよう、USDM準拠度とトレーサビリティに高い重みを付与。  
- 非機能要求もUSDM表で管理し、検証可能な受入基準へ直結させる。  

🔁 改善履歴（Diff）

- 初版（v1.0.0）：USDM準拠SRSカードを定義（Rubric/テンプレ付属）

🧰 付録A: 体裁テンプレ

**A-1. USDM表（Markdownテンプレ）**

最小必須列: ID / 種別 / レベル / 親ID / 要求 or 仕様 / 理由 / 説明 / 受入基準 / テスト観点 / 優先度 / 状態 / 出典 / 備考

| ID | 種別 | レベル | 親ID | 要求/仕様の記述 | 理由（意図/背景） | 説明（補足/用語） | 受入基準（検証方法） | テスト観点 | 優先度 | 状態 | 出典/根拠 | 備考 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| R-001 | 要求 | 1 | – | 登録ユーザーに認証を提供する | 不正利用防止のため | MFAの採用を検討 | ログイン成功/失敗条件を定義 | 正常/異常 | 高 | Draft | 規程#12 | |
| R-001.1 | 要求 | 2 | R-001 | パスワード忘れ時に再設定を可能にする | 問い合わせ削減 | メールによる本人確認 | 再設定リンクが有効/一意/有効期限内 | セキュリティ | 中 | Draft | – | |
| S-010 | 仕様 | 2 | R-001.1 | 再設定トークンを15分・1回限りで発行する | R-001.1の実現 | 乱数128bit以上 | 単体/結合で期限切れ・多重利用を検出 | 境界値 | 高 | Draft | R-001.1 | |

**A-2. USDM表（CSVテンプレ）**

```
ID,種別,レベル,親ID,要求_仕様の記述,理由,説明,受入基準,テスト観点,優先度,状態,出典,備考
R-001,要求,1,,登録ユーザーに認証を提供する,不正利用防止のため,MFAの採用を検討,ログイン成功/失敗の判定が再現可能,正常/異常,高,Draft,規程#12,
S-010,仕様,2,R-001,再設定トークンを15分・1回限りで発行する,R-001の実現,乱数128bit以上,期限切れ・多重利用を検出,境界値,高,Draft,R-001,
```

**A-3. USDM表（YAMLスキーマ例）**

```yaml
items:
  - id: "R-001"
    type: "requirement"
    level: 1
    parent: null
    text: "登録ユーザーに認証を提供する"
    reason: "不正利用防止"
    note: "MFAの採用を検討"
    acceptance: ["成功/失敗条件が定義される"]
    test: ["正常", "異常"]
    priority: "High"
    status: "Draft"
    sources: ["規程#12"]
  - id: "S-010"
    type: "spec"
    level: 2
    parent: "R-001"
    text: "再設定トークンを15分・1回限りで発行"
    reason: "R-001の実現"
    acceptance: ["期限切れ/多重利用で無効化される"]
```

**A-4. 記述マナー（チェックリスト）**

- 要求は目的語＋動詞で、条件を明示（いつ/どこで/何を/どうする）。  
- 理由は要求者視点で背景・目的を一文で。  
- 説明は用語・具体例の補足（仕様は書かない）。  
- 仕様は誰が作っても同じ結果になる具体度で、複合要件は分割。  
- 階層化（上位→下位）とID固定、受入基準の明文化。 (Qiita)  

**A-5. 受入基準テンプレ（Given/When/Then）**

```
シナリオ: パスワード再設定トークンの有効期限
  前提: ユーザーAに再設定トークンTが発行されている
  もし: 発行から15分を超えてTで再設定を試みる
  ならば: 再設定は拒否され、再申請を促すメッセージが表示される
```

🧰 付録B: 例示スコアリングの粒度

- 4: 期待を大幅に上回る。第三者検証でも揺るがない具体性。  
- 3: 期待を満たす。軽微な改善で十分。  
- 2: 最低限。重要箇所に具体性不足。  
- 1: 問題あり。構造や根拠が弱い。  
- 0: 不適合/欠落。やり直し。  

参考（USDMの背景資料）

- USDMの定義・着想・記述サンプル、Excel運用の一般性。 (Eureka Box)  
- 要素「要求/理由/説明/仕様」と目的語＋動詞、階層化の要点。 (Qiita)  
- 仕様は要求に根拠があり、目的語/動詞から仕様を抽出する考え方。 (Sky Group)  
```

### 本文セクション
- `# 🎯 目的 (Objective)`: プロンプトの狙い、対象ユーザー、期待アウトカム。  
- `# 🧭 生成指針 (Guidance)`: モデルが守るべき論調、禁止事項、出力要件。  
- `# ✍️ 生成プロンプト (generation_prompt)`: 実際にモデルへ渡す指示。` ```prompt ` ブロックで明示。  
- `✅ 評価基準 (Rubric)`: 観点・説明・重み・自動チェック方法を表で整理。`evaluation.judge` などの機械可読フィールドで delta verify が参照する。  
- `📦 サンプル (Samples)`: 代表的な入出力例をラベリングしたデータとして保持。  
- `🔁 Regression Set`: 品質維持のための固定入力。バージョンアップ時に再実行する。  
- `🪵 Changelog`: バージョン履歴、修正内容、評価結果を記録。  

これにより AI にとって解析しやすく、人間にも読みやすい二面仕様を実現します。

## プロジェクトフロー
1. **PromptCard 作成**: ユーザー/開発者が仕様・要件を提示し、AI アシスタント (Petri/TeamPal) が初版を生成。  
2. **生成 → 評価**: Refinire や Petri の Evaluation モードで PromptCard に沿った出力をチェック。  
3. **改善**: Rubric の低スコア観点を Guidance/Prompt と合わせて調整し、Changelog に反映・バージョンアップ。  
4. **Regression Test**: 過去サンプルで再評価し、品質が悪化していないことを確認したうえで `stable` 化。  
5. **運用**: stable な PromptCard をアプリ、CLI、ワークフローが参照し、仕様どおりの出力を継続供給。  

## AI エージェントの学習ポイント
- **生成＋評価の完全仕様**: `generation_prompt` で生成、`rubric/evaluation` で自動検証を行う。  
- **バージョン管理の遵守**: 常に最新の stable バージョンを参照し、draft に勝手に切り替えない。  
- **delta verify の活用**: Rubric を使って自動採点・不一致検知・改善案生成まで実行する。  
- **delta propose による改善**: 失点観点にもとづき、PromptCard 改善案 (diff) を提示する。  

## 導入効果
1. プロンプトの暗黙知がなくなり、誰が読んでも品質要件を理解できる。  
2. Rubric によって評価と改善が自動化し、AI 自身が改善ポイントを把握できる。  
3. テスト通過率やスコア推移などのメトリクスで品質を追跡できる。  
4. モデルが変わっても外部化された仕様でエージェントの安定性を確保できる。  
5. PromptCard が台帳としてリポジトリに蓄積され、レビュー・PR・版管理が可能になる。  

## 配置推奨
- PromptCard ファイルは `context-delta/prompts/` などプロンプト資産専用ディレクトリで管理し、draft/stable/deprecated を明示的にディレクトリまたは Front Matter で切り分ける。  
- delta CLI (例: `delta init --update-root-agents`) でテンプレート更新を行い、Rubric 変更時は `context-delta validate` や `delta verify` をセットで実行して記録する。  
- PromptCard を追加・更新したら `delta card sync` で `docs/promptcards/registry.(md|json)` を再生成し、delta propose/apply/archive/verify が参照するカード一覧を常に最新化する。  
- Context Delta は Proactive Delta Context の思想に基づき、差分単位でドキュメントを整流する。PromptCard の Rubric/Regression を整備すると、`delta verify` がリーンな品質ゲートとして機能しやすくなる。詳細は `docs/proactive-delta-context.md` を参照。
- Regression Set・Samples は `docs/` や `context-delta/changes/` に紐付け、タスク完了時は `plan.md` や Changelog と同期させる。  

これらを守ることで、PromptCard をプロジェクト内の再利用性の高い資産として運用できます。
